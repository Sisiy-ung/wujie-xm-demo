{"version":3,"file":"event.js","names":["warn","error","WUJIE_ALL_EVENT","WUJIE_TIPS_NO_SUBJECT","appEventObjMap","_window$__WUJIE_INJEC","window","__WUJIE_INJECT","cacheMap","__POWERED_BY_WUJIE__","__WUJIE","inject","Map","_objectSpread","EventBus","id","_classCallCheck","$clear","get","set","eventObj","_createClass","key","value","$on","event","fn","cbs","includes","push","$onAll","$once","on","$off","apply","arguments","bind","length","concat","cb","i","splice","$offAll","$emit","allCbs","forEach","_len","args","Array","_key","l","_cbs","_allCbs","e","_appEventObjMap$get","events","Object","keys"],"sources":["../src/event.ts"],"sourcesContent":["import { warn, error } from \"./utils\";\nimport { WUJIE_ALL_EVENT, WUJIE_TIPS_NO_SUBJECT } from \"./constant\";\n\nexport type EventObj = { [event: string]: Array<Function> };\n\n// 全部事件存储map\n// 除了挂载到WuJie实例上，还挂载到全局__WUJIE_INJECT变量上，防止重复创建\nexport const appEventObjMap = (() => {\n  if (window.__WUJIE_INJECT?.appEventObjMap) return window.__WUJIE_INJECT.appEventObjMap;\n  else {\n    const cacheMap = window.__POWERED_BY_WUJIE__ ? window.__WUJIE.inject.appEventObjMap : new Map<String, EventObj>();\n    window.__WUJIE_INJECT = { ...window.__WUJIE_INJECT, appEventObjMap: cacheMap };\n    return cacheMap;\n  }\n})();\n\n// eventBus 事件中心\nexport class EventBus {\n  private id: string;\n  private eventObj: EventObj;\n\n  constructor(id: string) {\n    this.id = id;\n    this.$clear();\n    if (!appEventObjMap.get(this.id)) {\n      appEventObjMap.set(this.id, {});\n    }\n    this.eventObj = appEventObjMap.get(this.id);\n  }\n\n  // 监听事件\n  public $on(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!cbs) {\n      this.eventObj[event] = [fn];\n      return this;\n    }\n    if (!cbs.includes(fn)) cbs.push(fn);\n    return this;\n  }\n\n  /** 任何$emit都会导致监听函数触发，第一个参数为事件名，后续的参数为$emit的参数 */\n  public $onAll(fn: (event: string, ...args: Array<any>) => any): EventBus {\n    return this.$on(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 一次性监听事件\n  public $once(event: string, fn: Function): void {\n    const on = function (...args: Array<any>) {\n      this.$off(event, on);\n      fn(...args);\n    }.bind(this);\n    this.$on(event, on);\n  }\n\n  // 取消监听\n  public $off(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!event || !cbs || !cbs.length) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n      return this;\n    }\n\n    let cb;\n    let i = cbs.length;\n    while (i--) {\n      cb = cbs[i];\n      if (cb === fn) {\n        cbs.splice(i, 1);\n        break;\n      }\n    }\n    return this;\n  }\n\n  // 取消监听$onAll\n  public $offAll(fn: Function): EventBus {\n    return this.$off(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 发送事件\n  public $emit(event: string, ...args: Array<any>): EventBus {\n    let cbs = [];\n    let allCbs = [];\n\n    appEventObjMap.forEach((eventObj) => {\n      if (eventObj[event]) cbs = cbs.concat(eventObj[event]);\n      if (eventObj[WUJIE_ALL_EVENT]) allCbs = allCbs.concat(eventObj[WUJIE_ALL_EVENT]);\n    });\n\n    if (!event || (cbs.length === 0 && allCbs.length === 0)) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n    } else {\n      try {\n        for (let i = 0, l = cbs.length; i < l; i++) cbs[i](...args);\n        for (let i = 0, l = allCbs.length; i < l; i++) allCbs[i](event, ...args);\n      } catch (e) {\n        error(e);\n      }\n    }\n    return this;\n  }\n\n  // 清空当前所有的监听事件\n  public $clear(): EventBus {\n    const eventObj = appEventObjMap.get(this.id) ?? {};\n    const events = Object.keys(eventObj);\n    events.forEach((event) => delete eventObj[event]);\n    return this;\n  }\n}\n"],"mappings":"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","ignoreList":[]}