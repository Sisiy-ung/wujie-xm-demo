{"version":3,"file":"plugin.js","names":["compose","getAbsolutePath","getCssLoader","_ref","plugins","replace","code","src","arguments","length","undefined","base","map","plugin","cssLoader","getJsLoader","_ref2","jsLoader","getPresetLoaders","loaderType","loaders","filter","res","reduce","preLoaders","curLoaders","concat","reverse","getEffectLoaders","isMatchUrl","url","effectLoaders","some","loader","test","cssRelativePathResolve","baseUrl","urlReg","_m","pre","post","base64Regx","isBase64","defaultPlugin","cssBeforeLoaders","content","getPlugins","Array","isArray","_toConsumableArray"],"sources":["../src/plugin.ts"],"sourcesContent":["import { plugin, ScriptObjectLoader } from \"./index\";\nimport { StyleObject } from \"./template\";\nimport { compose, getAbsolutePath } from \"./utils\";\n\ninterface loaderOption {\n  plugins: Array<plugin>;\n  replace: (code: string) => string;\n}\n\n/**\n * 获取柯里化 cssLoader\n */\nexport function getCssLoader({ plugins, replace }: loaderOption) {\n  return (code: string, src: string = \"\", base: string): string =>\n    compose(plugins.map((plugin) => plugin.cssLoader))(replace ? replace(code) : code, src, base);\n}\n\n/**\n * 获取柯里化 jsLoader\n */\nexport function getJsLoader({ plugins, replace }: loaderOption) {\n  return (code: string, src: string = \"\", base: string): string =>\n    compose(plugins.map((plugin) => plugin.jsLoader))(replace ? replace(code) : code, src, base);\n}\n\n/**\n * 获取预置插件\n */\ntype presetLoadersType = \"cssBeforeLoaders\" | \"cssAfterLoaders\" | \"jsBeforeLoaders\" | \"jsAfterLoaders\";\nexport function getPresetLoaders(loaderType: presetLoadersType, plugins: Array<plugin>): plugin[presetLoadersType] {\n  const loaders: (StyleObject | ScriptObjectLoader)[][] = plugins\n    .map((plugin) => plugin[loaderType])\n    .filter((loaders) => loaders?.length);\n  const res = loaders.reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\n  return loaderType === \"cssBeforeLoaders\" ? res.reverse() : res;\n}\n\n/**\n * 获取影响插件\n */\ntype effectLoadersType = \"jsExcludes\" | \"cssExcludes\" | \"jsIgnores\" | \"cssIgnores\";\nexport function getEffectLoaders(loaderType: effectLoadersType, plugins: Array<plugin>): plugin[effectLoadersType] {\n  return plugins\n    .map((plugin) => plugin[loaderType])\n    .filter((loaders) => loaders?.length)\n    .reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\n}\n\n// 判断 url 是否符合loader的规则\nexport function isMatchUrl(url: string, effectLoaders: plugin[effectLoadersType]): boolean {\n  return effectLoaders.some((loader) => (typeof loader === \"string\" ? url === loader : loader.test(url)));\n}\n\n/**\n * 转换子应用css内的相对地址成绝对地址\n */\nfunction cssRelativePathResolve(code: string, src: string, base: string) {\n  const baseUrl = src ? getAbsolutePath(src, base) : base;\n  /**\n   * https://developer.mozilla.org/en-US/docs/Web/CSS/url\n   *\n   * 旧: const urlReg = /(url\\((?!['\"]?(?:data):)['\"]?)([^'\")]*)(['\"]?\\))/g;\n   *\n   * 这里修改一下正则匹配，先匹配url(xxx)内的xxx，需要兼容一下嵌套括号，\n   * 再判断是否为base64，不再预先忽略data:前缀，防止base64的svg内仍有url被匹配\n   *\n   * eg:\n   * background: url(data:image/svg+xml;charset=utf-8,<svg><path fill=url(#a)></path></svg>)\n   * 以上样式会匹配出#a并进行修改，svg填充的路径就出问题了。\n   *\n   *  */\n  const urlReg = /url\\((['\"]?)((?:[^()]+|\\((?:[^()]+|\\([^()]*\\))*\\))*)(\\1)\\)/g;\n\n  return code.replace(urlReg, (_m, pre, url, post) => {\n    const base64Regx = /^data:/;\n    const isBase64 = base64Regx.test(url);\n\n    /** 如果匹配到data:前缀，则认为是base64文件，直接不进行路径替换吧 */\n    if (isBase64) {\n      return _m;\n    }\n\n    return `url(${pre}${getAbsolutePath(url, baseUrl)}${post})`;\n  });\n}\n\nconst defaultPlugin = {\n  cssLoader: cssRelativePathResolve,\n  // fix https://github.com/Tencent/wujie/issues/455\n  cssBeforeLoaders: [{ content: \"html {view-transition-name: none;}\" }],\n};\n\nexport function getPlugins(plugins: Array<plugin>): Array<plugin> {\n  return Array.isArray(plugins) ? [defaultPlugin, ...plugins] : [defaultPlugin];\n}\n\nexport default defaultPlugin;\n"],"mappings":"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","ignoreList":[]}